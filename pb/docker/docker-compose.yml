x-build-common: &buildkit
services:
  # ===== Network components =====
  registry:
    container_name: ${REGISTRY_NAME}
    image: registry:2
    hostname: ${REGISTRY_NAME:-registry}
    restart: always
    networks: [net]
    ports:
      - "${REGISTRY_PORT}:${REGISTRY_PORT}"
    environment:
      REGISTRY_STORAGE_DELETE_ENABLED: "true"
      REGISTRY_HTTP_ADDR: "0.0.0.0:${REGISTRY_PORT}"
      REGISTRY_AUTH: "htpasswd"
      REGISTRY_AUTH_HTPASSWD_REALM: "Registry Realm"
      REGISTRY_AUTH_HTPASSWD_PATH: "/auth/htpasswd"
      REGISTRY_HTTP_TLS_CERTIFICATE: "/auth/certs/domain.crt"
      REGISTRY_HTTP_TLS_KEY: "/auth/certs/domain.key"
    volumes:
      - "./registry:/auth"
      
#  load-generator:
#    container_name: load-generator
#    image: load-generator:${IMAGE_VERSION:-2.0.2}
#    hostname: load-generator
#    restart: unless-stopped
#    networks: [net]
#    build:
#      context: ../../src/load-generator
#      dockerfile: ../../src/load-generator/Dockerfile
#    environment:
#      PLAYWRIGHT_BROWSERS_PATH: "/opt/pw-browsers"
#      LOCUST_WEB_HOST: "0.0.0.0"
#      LOCUST_WEB_PORT: "8089"
#      LOCUST_USERS: "20"
#      LOCUST_SPAWN_RATE: "10" 
#      LOCUST_HOST: "http://${PROXY}:8080" 
#      LOCUST_HEADLESS: "true" 
#      LOCUST_AUTOSTART: "true" 
#      LOCUST_BROWSER_TRAFFIC_ENABLED: "true"

  samba:
    container_name: samba-pv
    image: samba:${IMAGE_VERSION:-2.0.2}
    hostname: samba-pv
    restart: unless-stopped
    networks: [net]
    build:
      context: ../../src/samba
      dockerfile: Dockerfile
    environment:
      TZ: Europe/Rome
      SAMBA_USER: k8s
      SAMBA_PASS: password
      SAMBA_UID: "10001"
      SAMBA_GID: "10001"
      SHARE_NAME: pvroot
      SHARE_PATH: /share
      HOSTS_ALLOW: "127. 172.18.0. 172.19.0. 192.168."
      ENCRYPTION: required
      LOG_LEVEL: "1"
    cap_add:
      - NET_BIND_SERVICE
      - CHOWN
    read_only: false
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 445"]
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 10s

  proxy:
    container_name: ${PROXY:-proxy}
    image: nginx:1.27-alpine
    hostname: ${PROXY:-proxy}
    restart: unless-stopped
    networks: [net]
    ports:
      - "0.0.0.0:8888:8888"
      - "0.0.0.0:8080:8080"
    environment:
      CALDERA_SERVER: ${CALDERA_SERVER}
      FRONTEND_PROXY: ${FRONTEND_PROXY_IP}
      NGINX_ENVSUBST_OUTPUT_DIR: /etc/nginx
    volumes:
      - ./proxy/nginx.conf.template:/etc/nginx/templates/nginx.conf.template:ro
      - ./proxy/conf.d-empty/:/etc/nginx/conf.d:ro
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 10s
      timeout: 3s
      retries: 5
    depends_on:
      - caldera-server

  # ===== Caldera =====
  caldera-controller:
    container_name: ${CALDERA_CONTROLLER:-caldera.cont}
    image: caldera-controller:${IMAGE_VERSION:-2.0.2}
    hostname: ${CALDERA_CONTROLLER:-caldera.cont}
    restart: unless-stopped
    networks: [net]
    build:
      context: ../../src/caldera-controller
      dockerfile: ../../src/caldera-controller/Dockerfile
    environment:
      CALDERA_URL: "http://${CALDERA_SERVER}:8888"
      KUBECONFIG: "/kube/kubeconfig"
      ADV_LIST: "${ADV_LIST}"
      ENABLEKC1: ${ENABLEKC1:-true}
      ENABLEKC2: ${ENABLEKC2:-true}
      ENABLEKC3: ${ENABLEKC3:-true}
      ENABLEKC4: ${ENABLEKC4:-true}
      ENABLEKC5: ${ENABLEKC5:-true}
      ENABLEKC6: ${ENABLEKC6:-true}
      SCRIPT_PRE_KC1: "${SCRIPT_PRE_KC1}"
      SCRIPT_PRE_KC2: "${SCRIPT_PRE_KC2}"
      SCRIPT_PRE_KC3: "${SCRIPT_PRE_KC3}"
      SCRIPT_PRE_KC4: "${SCRIPT_PRE_KC4}"
      SCRIPT_PRE_KC5: "${SCRIPT_PRE_KC5}"
      SCRIPT_PRE_KC6: "${SCRIPT_PRE_KC6}"
      SCRIPT_POST_KC1: "${SCRIPT_POST_KC1}"
      SCRIPT_POST_KC2: "${SCRIPT_POST_KC2}"
      SCRIPT_POST_KC3: "${SCRIPT_POST_KC3}"
      SCRIPT_POST_KC4: "${SCRIPT_POST_KC4}"
      SCRIPT_POST_KC5: "${SCRIPT_POST_KC5}"
      SCRIPT_POST_KC6: "${SCRIPT_POST_KC6}"
    volumes:
      - ./controller/scripts:/scripts
      - ./controller/kube:/kube:ro

  attacker:
    container_name: ${ATTACKER:-caldera.outs}
    image: attacker:${IMAGE_VERSION:-2.0.2}
    hostname: ${ATTACKER:-caldera.outs}
    restart: unless-stopped
    networks: [net]
    build:
      context: ../../src/attacker
      dockerfile: ../../src/attacker/Dockerfile
      args:
        DOCKER_DAEMON: "1"
        CALDERA_URL: "http://${CALDERA_SERVER}:8888"
        GROUP: "outside"
        ATTACKERADDR: "${ATTACKER}"
    privileged: true
    environment:
      WAIT: "0"
      CALDERA_URL: "http://${CALDERA_SERVER}:8888"
      HOSTREGISTRY: "$REGISTRY_NAME:$REGISTRY_PORT"
      ARP_VICTIM: ${PROXY:-proxy}
      FRONTEND_PROXY_IP: ${FRONTEND_PROXY_IP}
      CONTROL_PLANE_NODE: ${CONTROL_PLANE_NODE:-kind-control-plane}
      CONTROL_PLANE_PORT: ${KUBESERVER_PORT:-6443}
      K8S_IMAGE: ${K8S_IMAGE:-registry.k8s.io/kube-apiserver:v1.30.0}
      REGISTRY_USER: ${REGISTRY_USER:-testuser}
      REGISTRY_PASS: ${REGISTRY_PASS:-testpassword}
      LOG_NS: "$MEM_NAMESPACE"
      ATTACKED_NS: "$DMZ_NAMESPACE"
      AUTH_NS: "$APP_NAMESPACE"
      ATTACKERADDR: "$ATTACKER"
      NSPROTO: "$APP_NAMESPACE"
      NSCREDS: "$MEM_NAMESPACE"
      NSPAYMT: "$PAY_NAMESPACE"
      # KC2
      KC0201: "$KC0201"
      KC0202: "$KC0202"
      KC0203: "$KC0203"
      KC0204: "$KC0204"
      KC0205: "$KC0205"
      KC0206: "$KC0206"
      KC0207: "$KC0207"
      KC0208: "$KC0208"
      # KC3
      KC0301: "$KC0301"
      KC0302: "$KC0302"
      KC0303: "$KC0303"
      KC0304: "$KC0304"
      KC0305: "$KC0305"
      KC0306: "$KC0306"
      KC0307: "$KC0307"
      KC0308: "$KC0308"
      # KC4
      KC0401: "$KC0401"
      KC0402: "$KC0402"
      KC0403: "$KC0403"
      KC0404: "$KC0404"
      KC0405: "$KC0405"
      KC0406: "$KC0406"
      KC0407: "$KC0407"
      KC0408: "$KC0408"
      # KC5
      KC0501: "$KC0501"
      KC0502: "$KC0502"
      KC0503: "$KC0503"
      KC0504: "$KC0504"
      KC0505: "$KC0505"
      KC0506: "$KC0506"
      KC0507: "$KC0507"
      KC0508: "$KC0508"
      KC0509: "$KC0509"
      KC0510: "$KC0510"
      # KC6
      KC0601: "$KC0601"
      KC0602: "$KC0602"
      KC0603: "$KC0603"
      KC0604: "$KC0604"
      KC0605: "$KC0605"
      KC0606: "$KC0606"
      KC0607: "$KC0607"
      KC0608: "$KC0608"
      KC0609: "$KC0609"
      KC0610: "$KC0610"
      KC0611: "$KC0611"
    volumes:
      - ./attacker/apiserver:/apiserver
      - ./attacker/iphost:/tmp/iphost
      - ./attacker/results:/tmp/KCData
    depends_on:
      caldera-server:
        condition: service_healthy

  caldera-server:
    container_name: ${CALDERA_SERVER:-caldera.dock}
    image: ghcr.io/mitre/caldera:5.2.0
    hostname: ${CALDERA_SERVER:-caldera.dock}
    restart: unless-stopped
    networks: [net]
    volumes:
      - ./caldera/local.yml:/usr/src/app/conf/local.yml
      - ./caldera/adversaries:/usr/src/app/plugins/stockpile/data/adversaries/personal
      - ./caldera/abilities:/usr/src/app/plugins/stockpile/data/abilities/personal
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8888/ || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 24
      start_period: 15s

networks:
  net:
    external: true
    name: ${CP_NETWORK:-minikube}
