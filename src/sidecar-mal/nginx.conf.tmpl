# NGINX as L7 sidecar: proxy + mirroring
worker_processes auto;
events { worker_connections 1024; }

http {
  # DNS resolution for the mirroring host
  resolver $RESOLVER_IP valid=30s ipv6=off;

  # Transparent logs (not “invisible”): recommended for audit/compliance
  access_log /var/log/nginx/access.log;
  error_log  /var/log/nginx/error.log warn;

  # Configurable timeouts
  proxy_connect_timeout  $CONNECT_TIMEOUT;
  proxy_read_timeout     $READ_TIMEOUT;
  proxy_send_timeout     $SEND_TIMEOUT;

  # Primary upstream (IP:PORT from env)
  upstream primary_upstream {
    server $PRIMARY_ADDR max_fails=2 fail_timeout=5s;
  }

  server {
    listen 8080;          # Incoming requests from the app / cluster
    listen [::]:8080;

    # Duplicate every request to /_mirror as a subrequest
    # NOTE: the subrequest does not affect the client response.
    location / {
      mirror /_mirror;            # enable mirroring
      mirror_request_body on;     # duplicate body as well

      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_pass http://primary_upstream;
    }

    # “Shadow” location used for mirroring
    location = /_mirror {
      internal;
      # Direct pass to the mirror via DNS name (host:port)
      proxy_set_header Host $host;
      proxy_pass http://$MIRROR_ADDR$request_uri;
      # Do not fail the main request if the mirror is unreachable
      proxy_intercept_errors off;
      proxy_next_upstream off;
    }
  }
}
